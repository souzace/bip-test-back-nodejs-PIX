version: "3.9"

services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: pix
      POSTGRES_USER: pix
      POSTGRES_PASSWORD: pix
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ../scripts/db-init.sql:/docker-entrypoint-initdb.d/01-db-init.sql
      - ../scripts/seed.sql:/docker-entrypoint-initdb.d/02-seed.sql
    networks:
      - pix-network

  mongo:
    image: mongo:6
    networks:
      - pix-network

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    networks:
      - pix-network

  rabbitmq:
    image: rabbitmq:3-management
    networks:
      - pix-network

  pix-api-java:
    build: ../services/pix-api-java
    depends_on: [postgres, kafka]
    environment:
      DB_URL: jdbc:postgresql://postgres:5432/pix
      DB_USER: pix
      DB_PASS: pix
    ports:
      - "8081:8080"
    networks:
      - pix-network
      
  pix-api-java-test:
    image: maven:3.8.8-eclipse-temurin-17
    working_dir: /app
    volumes:
      - ../services/pix-api-java:/app
    command: mvn test -B -Dsurefire.printSummary=true -Dsurefire.reportFormat=plain
    networks:
      - pix-network

  pix-api-node:
    build: ../services/pix-api-node
    depends_on: [mongo, kafka]

  frontend:
    build: ../frontend
    depends_on: [pix-api-java]
    ports:
      - "4200:80"
    networks:
      - pix-network

  # EJB WildFly Server
  wildfly:
    image: quay.io/wildfly/wildfly:31.0.0.Final-jdk17
    container_name: pix-wildfly
    ports:
      - "8080:8080"
      - "9990:9990"
    environment:
      - WILDFLY_USER=admin
      - WILDFLY_PASS=admin
    volumes:
      - ./ejb-module/target/ejb-module-1.0.0.jar:/opt/jboss/wildfly/standalone/deployments/
    networks:
      - pix-network
    command: >
      /bin/bash -c "
      /opt/jboss/wildfly/bin/add-user.sh admin admin --silent &&
      /opt/jboss/wildfly/bin/standalone.sh -b 0.0.0.0 -bmanagement 0.0.0.0
      "
   # Servi√ßo para compilar e testar o EJB
  ejb-test:
    image: maven:3.9-eclipse-temurin-17
    working_dir: /app
    volumes:
      - ../ejb-module:/app
      - maven-cache:/root/.m2
    command: mvn clean test -B
    networks:
      - pix-network

volumes:
  pgdata:
  maven-cache:

networks:
  pix-network:
    driver: bridge